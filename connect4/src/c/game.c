#include <stdio.h>
#include <assert.h>
#include <string.h>

#include <game.h>

#define MY_ABS(X) (((X) < 0) ? (-X) : (X))

const int numActions(void) {
  return 7;
}

const int gameLength(void) {
  return 45;
}

const int inputLength(void) {
  return 42;
}


// In Connect4, we will encode the game state g
// as a numpy array of length 45, consisting of float values
// 0..41 is the board, 42 is the player, 43 is ended, 44 is terminal score.

// Connect4 board layout:
// 35 36 37 38 39 40 41
// 28 29 30 31 32 33 34
// 21 22 23 24 25 26 27
// 14 15 16 17 18 19 20
//  7  8  9 10 11 12 13
//  0  1  2  3  4  5  6

const int checksums[69*4] = 
  {0,1,2,3, /* 0 */ 
   1,2,3,4, /* 1 */ 
   2,3,4,5, /* 2 */ 
   3,4,5,6, /* 3 */ 
   7,8,9,10, /* 4 */ 
   8,9,10,11, /* 5 */ 
   9,10,11,12, /* 6 */ 
   10,11,12,13, /* 7 */ 
   14,15,16,17, /* 8 */ 
   15,16,17,18, /* 9 */ 
   16,17,18,19, /* 10 */ 
   17,18,19,20, /* 11 */ 
   21,22,23,24, /* 12 */ 
   22,23,24,25, /* 13 */ 
   23,24,25,26, /* 14 */ 
   24,25,26,27, /* 15 */ 
   28,29,30,31, /* 16 */ 
   29,30,31,32, /* 17 */ 
   30,31,32,33, /* 18 */ 
   31,32,33,34, /* 19 */ 
   35,36,37,38, /* 20 */ 
   36,37,38,39, /* 21 */ 
   37,38,39,40, /* 22 */ 
   38,39,40,41, /* 23 */ 
   0,7,14,21, /* 24 */ 
   7,14,21,28, /* 25 */ 
   14,21,28,35, /* 26 */ 
   1,8,15,22, /* 27 */ 
   8,15,22,29, /* 28 */ 
   15,22,29,36, /* 29 */ 
   2,9,16,23, /* 30 */ 
   9,16,23,30, /* 31 */ 
   16,23,30,37, /* 32 */ 
   3,10,17,24, /* 33 */ 
   10,17,24,31, /* 34 */ 
   17,24,31,38, /* 35 */ 
   4,11,18,25, /* 36 */ 
   11,18,25,32, /* 37 */ 
   18,25,32,39, /* 38 */ 
   5,12,19,26, /* 39 */ 
   12,19,26,33, /* 40 */ 
   19,26,33,40, /* 41 */ 
   6,13,20,27, /* 42 */ 
   13,20,27,34, /* 43 */ 
   20,27,34,41, /* 44 */ 
   3,9,15,21, /* 45 */ 
   4,10,16,22, /* 46 */ 
   5,11,17,23, /* 47 */ 
   6,12,18,24, /* 48 */ 
   10,16,22,28, /* 49 */ 
   11,17,23,29, /* 50 */ 
   12,18,24,30, /* 51 */ 
   13,19,25,31, /* 52 */ 
   17,23,29,35, /* 53 */ 
   18,24,30,36, /* 54 */ 
   19,25,31,37, /* 55 */ 
   20,26,32,38, /* 56 */ 
   0,8,16,24, /* 57 */ 
   1,9,17,25, /* 58 */ 
   2,10,18,26, /* 59 */ 
   3,11,19,27, /* 60 */ 
   7,15,23,31, /* 61 */ 
   8,16,24,32, /* 62 */ 
   9,17,25,33, /* 63 */ 
   10,18,26,34, /* 64 */ 
   14,22,30,38, /* 65 */ 
   15,23,31,39, /* 66 */ 
   16,24,32,40, /* 67 */ 
   17,25,33,41}; /* 68 */ 

const int checks[42][13] = 
  {{0,24,57,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1}, /* 0 */ 
   {0,1,27,58,-1,-1,-1,-1,-1,-1,-1,-1,-1}, /* 1 */ 
   {0,1,2,30,59,-1,-1,-1,-1,-1,-1,-1,-1}, /* 2 */ 
   {0,1,2,3,33,45,60,-1,-1,-1,-1,-1,-1}, /* 3 */ 
   {1,2,3,36,46,-1,-1,-1,-1,-1,-1,-1,-1}, /* 4 */ 
   {2,3,39,47,-1,-1,-1,-1,-1,-1,-1,-1,-1}, /* 5 */ 
   {3,42,48,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1}, /* 6 */ 
   {4,24,25,61,-1,-1,-1,-1,-1,-1,-1,-1,-1}, /* 7 */ 
   {4,5,27,28,57,62,-1,-1,-1,-1,-1,-1,-1}, /* 8 */ 
   {4,5,6,30,31,45,58,63,-1,-1,-1,-1,-1}, /* 9 */ 
   {4,5,6,7,33,34,46,49,59,64,-1,-1,-1}, /* 10 */ 
   {5,6,7,36,37,47,50,60,-1,-1,-1,-1,-1}, /* 11 */ 
   {6,7,39,40,48,51,-1,-1,-1,-1,-1,-1,-1}, /* 12 */ 
   {7,42,43,52,-1,-1,-1,-1,-1,-1,-1,-1,-1}, /* 13 */ 
   {8,24,25,26,65,-1,-1,-1,-1,-1,-1,-1,-1}, /* 14 */ 
   {8,9,27,28,29,45,61,66,-1,-1,-1,-1,-1}, /* 15 */ 
   {8,9,10,30,31,32,46,49,57,62,67,-1,-1}, /* 16 */ 
   {8,9,10,11,33,34,35,47,50,53,58,63,68}, /* 17 */ 
   {9,10,11,36,37,38,48,51,54,59,64,-1,-1}, /* 18 */ 
   {10,11,39,40,41,52,55,60,-1,-1,-1,-1,-1}, /* 19 */ 
   {11,42,43,44,56,-1,-1,-1,-1,-1,-1,-1,-1}, /* 20 */ 
   {12,24,25,26,45,-1,-1,-1,-1,-1,-1,-1,-1}, /* 21 */ 
   {12,13,27,28,29,46,49,65,-1,-1,-1,-1,-1}, /* 22 */ 
   {12,13,14,30,31,32,47,50,53,61,66,-1,-1}, /* 23 */ 
   {12,13,14,15,33,34,35,48,51,54,57,62,67}, /* 24 */ 
   {13,14,15,36,37,38,52,55,58,63,68,-1,-1}, /* 25 */ 
   {14,15,39,40,41,56,59,64,-1,-1,-1,-1,-1}, /* 26 */ 
   {15,42,43,44,60,-1,-1,-1,-1,-1,-1,-1,-1}, /* 27 */ 
   {16,25,26,49,-1,-1,-1,-1,-1,-1,-1,-1,-1}, /* 28 */ 
   {16,17,28,29,50,53,-1,-1,-1,-1,-1,-1,-1}, /* 29 */ 
   {16,17,18,31,32,51,54,65,-1,-1,-1,-1,-1}, /* 30 */ 
   {16,17,18,19,34,35,52,55,61,66,-1,-1,-1}, /* 31 */ 
   {17,18,19,37,38,56,62,67,-1,-1,-1,-1,-1}, /* 32 */ 
   {18,19,40,41,63,68,-1,-1,-1,-1,-1,-1,-1}, /* 33 */ 
   {19,43,44,64,-1,-1,-1,-1,-1,-1,-1,-1,-1}, /* 34 */ 
   {20,26,53,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1}, /* 35 */ 
   {20,21,29,54,-1,-1,-1,-1,-1,-1,-1,-1,-1}, /* 36 */ 
   {20,21,22,32,55,-1,-1,-1,-1,-1,-1,-1,-1}, /* 37 */ 
   {20,21,22,23,35,56,65,-1,-1,-1,-1,-1,-1}, /* 38 */ 
   {21,22,23,38,66,-1,-1,-1,-1,-1,-1,-1,-1}, /* 39 */ 
   {22,23,41,67,-1,-1,-1,-1,-1,-1,-1,-1,-1}, /* 40 */ 
   {23,44,68,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1}}; /* 41 */ 

void rootState(float* const g)
{
  int i;
  for(i=0;i<45;i++) g[i] = 0.0;
  g[42] = 1.0; // initial player id is 1
}

void inputNetwork(float* const x, const float* const g)
{
  int j;
  float player;

  player = g[42];
  memcpy(x, g, 42*sizeof(float));
  if(player < 0.0) {
    //flip sign
    for(j=0;j<42;j++) {
      x[j] = -x[j];
    }
  }

}

float playerId(const float* const g)
{
  return g[42];
}

int gameEnded(float* const terminal_score, const float* const g)
{
  *terminal_score = g[44];
  return (int) g[43];
}

int isValidAction(const float* const g, int const a) 
{
  if((a<0) || (a >= 7)) return 0;
  if(g[43] == 1.0) return 0;
  if(g[35+a] == 0.0) return 1;
  else return 0;
}

int getValidActions(int* const actions, const float* const g)
{
  int j;
  int count=0;
  
  if(g[43]==1.0) return 0;

  for(j=0;j<7;j++) {
    if(g[35+j]==0.0) {
      actions[count]=j;
      count++;
    }
  }
  return count;
}

//returns 1 if next state is terminal, 0 otherwise; returns -1 if action=a is not valid
int nextState(float* const ga, const float* const g, const int a)
{
  int i,j,k,pos;
  float p = g[42]; // player id
  float p4;
  float s;

  assert((a>=0) && (a<7));

  //first copy g into ga
  memcpy(ga, g, 45*sizeof(float));

  // flip player id
  ga[42] = -p;

  if(!isValidAction(g,a)) {
    ga[43] = 1.0;
    ga[44] = -p; // opposite player wins
    return -1;
  }

  //now we know that action a is valid, and so 
  //we make the appropriate updates to ga

  //placing checker in column a
  pos = -1;
  for(i=0;i<6;i++) {
    if(ga[a + 7*i] == 0.0) {
      pos = a + 7*i;
      ga[pos] = p; //places checker
      break;
    }
  }
  assert(pos != -1);

  //checking if the game has terminated.
  p4 = 4.0*p;
  for(i=0;i<13;i++) {
    j = checks[pos][i];
    if(j < 0) break;
    s = 0.0;
    for(k=0;k<4;k++) s += ga[checksums[4*j+k]];
    if(s == p4) {
      ga[43] = 1.0;
      ga[44] = p;
      return 1;
    }
  }

  // check if board is full
  s=0.0;
  for(i=35;i<42;i++) s += MY_ABS(ga[i]);
  if(s==7.0) {
    ga[43]=1.0;
    ga[44]=0.0; // draw
    return 1;
  }

  // game not over; returning 0
  return 0;
}

void printGame(const float* const g) {
  int i,j;
  for(i=5;i>=0;i--) {
    for(j=0;j<7;j++) {
      if(g[7*i+j]==1.0) printf(" x");
      else if(g[7*i + j] == -1.0) printf(" o");
      else printf(" .");
    }
    printf("\n");
  }
  if(g[43] == 0.0) {
    if(g[42] == 1.0) printf("x to move.\n");
    else printf("o to move.\n");
  }
  else {
    if(g[44] == 1.0) printf("x has won.\n");
    else if(g[44] == -1.0) printf("o has won.\n");
    else printf("it is a draw.\n");
  }
}
